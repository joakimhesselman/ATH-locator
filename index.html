<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALL TIME HIGH Success Locator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Dark Mode Anpassningar (samma som tidigare) */
      body {
        font-family: 'Inter', sans-serif;
        min-height: 100vh; margin: 0; display: flex; align-items: center; justify-content: center;
        background-color: #111827; color: #d1d5db; padding: 1rem; overflow: hidden;
      }
      .container {
        border: 2px solid #9ca3af; background-color: #1f2937; padding: 2rem; text-align: center;
        max-width: 22rem; width: 100%; border-radius: 0.25rem; color: #d1d5db;
      }
      .title {
        font-family: sans-serif; font-weight: 700; font-size: 1.5rem; line-height: 1.2;
        text-transform: uppercase; margin-bottom: 0.5rem; color: #f9fafb;
      }
      .separator {
          border: none; height: 2px; background-color: #9ca3af; margin-top: 0.5rem; margin-bottom: 2rem;
      }
      .arrow-circle {
          width: 10rem; height: 10rem; border-radius: 50%; background-color: #374151;
          border: 2px solid #9ca3af; display: flex; align-items: center; justify-content: center;
          margin: 0 auto 2rem auto; overflow: hidden;
      }
      #arrow-svg {
          width: 50%; height: 50%; transition: transform 0.1s linear; fill: #ef4444;
          stroke: #d1d5db; stroke-width: 5; stroke-linejoin: round;
      }
      .distance-text {
          color: #60a5fa; font-weight: 700; font-size: 1.25rem; margin-bottom: 0.25rem;
      }
      .target-text {
          color: #d1d5db; font-size: 0.875rem; margin-bottom: 1rem; /* Mindre marginal för att ge plats åt knapp */
      }
       .footer-separator {
          border: none; border-top: 2px dashed #9ca3af; margin-top: 1rem; margin-bottom: 0.5rem;
      }
      .footer-text {
          font-family: monospace; font-size: 0.875rem; color: #9ca3af;
      }
      #error { color: #f87171; }

      /* Pulsationsanimation (samma som tidigare) */
      @keyframes pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.5); }
        50% { transform: scale(1.05); box-shadow: 0 0 10px 10px rgba(96, 165, 250, 0); }
      }
      .pulsating { animation: pulse 1.5s infinite ease-in-out; }

      /* Stil för aktiveringsknapp */
      .activate-button {
          background-color: #10b981; /* Grön (Tailwind emerald-500) */
          color: white;
          font-weight: bold;
          padding: 0.5rem 1rem;
          border-radius: 0.25rem;
          border: 1px solid #059669; /* Mörkare grön kant */
          cursor: pointer;
          margin-bottom: 1rem; /* Utrymme under knappen */
          transition: background-color 0.2s;
      }
      .activate-button:hover {
          background-color: #059669; /* Mörkare grön vid hover */
      }
      .activate-button:disabled {
          background-color: #6b7280; /* Grå när inaktiv (Tailwind gray-500) */
          cursor: not-allowed;
          border-color: #4b5563;
      }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1 class="title">
            ALL TIME HIGH<br>SUCCESS LOCATOR
        </h1>
        <hr class="separator">

        <div class="arrow-circle">
            <svg id="arrow-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                <path d="M50 10 L90 50 L70 50 L70 90 L30 90 L30 50 L10 50 Z" />
            </svg>
        </div>

        <div id="info">
            <p id="distance" class="distance-text">Hämtar position...</p>
            <p class="target-text">Target: ALL TIME HIGH</p>
        </div>

        <button id="activateCompassButton" class="activate-button">Aktivera Kompass</button>

        <div id="error" class="mb-4 font-bold hidden"></div> {/* Flyttade felmeddelandet hit */}
        <hr class="footer-separator">
        <p class="footer-text">// ALWAYS POINTING TO SUCCESS //</p>

    </div>

    <script>
        // --- Element Referenser ---
        const arrowElement = document.getElementById('arrow-svg');
        const distanceElement = document.getElementById('distance');
        const errorElement = document.getElementById('error');
        const arrowCircleElement = document.querySelector('.arrow-circle');
        // Ny referens till knappen
        const activateCompassButton = document.getElementById('activateCompassButton');

        // --- Målkoordinater ---
        const targetLat = 59.30998428196858;
        const targetLon = 18.006478851446655;

        // --- Variabler för state ---
        let currentLat = null;
        let currentLon = null;
        let targetBearing = null;
        let deviceHeading = null;
        let orientationPermissionGranted = false;
        let orientationListenerActive = false; // Flagga för att se om lyssnaren är aktiv

        // --- Funktioner (Matematik, samma som tidigare) ---
        function toRadians(degrees) { return degrees * Math.PI / 180; }
        function toDegrees(radians) { return radians * 180 / Math.PI; }
        function calculateDistance(lat1, lon1, lat2, lon2) { /* ... samma ... */
            const R = 6371; const dLat = toRadians(lat2 - lat1); const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c;
         }
        function calculateBearing(lat1, lon1, lat2, lon2) { /* ... samma ... */
            const phi1 = toRadians(lat1); const lambda1 = toRadians(lon1); const phi2 = toRadians(lat2); const lambda2 = toRadians(lon2);
            const y = Math.sin(lambda2 - lambda1) * Math.cos(phi2); const x = Math.cos(phi1) * Math.sin(phi2) - Math.sin(phi1) * Math.cos(phi2) * Math.cos(lambda2 - lambda1);
            let brng = Math.atan2(y, x); brng = toDegrees(brng); return (brng + 360) % 360;
        }

        // --- UI Uppdateringsfunktioner ---
        function updateArrowRotation() {
            if (targetBearing !== null && deviceHeading !== null) {
                let rotationAngle = targetBearing - deviceHeading;
                arrowElement.style.transform = `rotate(${rotationAngle}deg)`;
                arrowElement.style.transformOrigin = 'center center';
                // Dölj ev. orienteringsfel om vi nu får data
                 if (errorElement.textContent.includes("orienteringsdata") || errorElement.textContent.includes("kompassdata")) {
                     hideError();
                 }
            }
        }

        function updateLocationUI(latitude, longitude) {
             currentLat = latitude; currentLon = longitude;
            try {
                const distanceKm = calculateDistance(latitude, longitude, targetLat, targetLon);
                targetBearing = calculateBearing(latitude, longitude, targetLat, targetLon);
                const distanceMeters = distanceKm * 1000;

                // Uppdatera avståndstext
                distanceElement.textContent = distanceMeters < 1000
                    ? `Distance: ${distanceMeters.toFixed(0)} m`
                    : `Distance: ${distanceKm.toFixed(1)} km`;

                // Hantera pulserande effekt
                if (distanceMeters < 200) {
                    if (!arrowCircleElement.classList.contains('pulsating')) {
                        arrowCircleElement.classList.add('pulsating');
                    }
                } else {
                    if (arrowCircleElement.classList.contains('pulsating')) {
                        arrowCircleElement.classList.remove('pulsating');
                    }
                }
                // Dölj ev. positionsfel
                if (!errorElement.textContent.includes("orienteringsdata") && !errorElement.textContent.includes("kompassdata")) {
                    hideError();
                }
                updateArrowRotation(); // Försök uppdatera rotationen direkt
            } catch (e) {
                console.error("Fel vid UI-uppdatering (plats):", e);
                showError('Ett internt fel uppstod vid platsuppdatering.');
                targetBearing = null;
                arrowCircleElement.classList.remove('pulsating');
            }
        }

        // --- Felhantering ---
        function showError(message) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            console.error("Felmeddelande:", message);
        }
        function hideError() {
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
        }
        function handleLocationError(error) { /* ... samma som tidigare ... */
             let message = 'Okänt fel vid hämtning av position.';
             switch(error.code) {
                case error.PERMISSION_DENIED: message = "Du nekade åtkomst till platsinformation."; break;
                case error.POSITION_UNAVAILABLE: message = "Platsinformation är inte tillgänglig."; break;
                case error.TIMEOUT: message = "Timeout vid hämtning av platsinformation."; break;
                case error.UNKNOWN_ERROR: message = "Ett okänt fel uppstod vid platsinhämtning."; break;
            }
            showError(message); distanceElement.textContent = 'Kunde inte hämta position.';
            currentLat = null; currentLon = null; targetBearing = null;
            arrowElement.style.transform = 'rotate(0deg)';
            arrowCircleElement.classList.remove('pulsating');
         }

        // --- Sensor/Event Hantering ---
        function handleOrientation(event) {
            let heading = event.alpha;
            if (typeof event.webkitCompassHeading !== 'undefined') { heading = event.webkitCompassHeading; }

            if (heading === null || typeof heading === 'undefined') {
                if (orientationPermissionGranted) { // Visa bara fel om vi tidigare haft åtkomst
                    showError("Kunde inte läsa kompassdata från enheten.");
                }
                deviceHeading = null; return;
            }
            // Om vi får data första gången, markera att åtkomst finns
            if (!orientationPermissionGranted) {
                 console.log("Orienteringsdata mottagen för första gången.");
                 orientationPermissionGranted = true;
                 // Dölj knappen när det funkar? (Valfritt)
                 // activateCompassButton.style.display = 'none';
                 // Eller inaktivera den
                 activateCompassButton.disabled = true;
                 activateCompassButton.textContent = 'Kompass Aktiv';
            }
            deviceHeading = heading;
            updateArrowRotation();
        }

        // Funktion som ANROPAS VID KNAPPTRYCK för att starta lyssnaren
        function requestOrientationPermission() {
            hideError(); // Dölj gamla fel innan vi försöker igen
            console.log("Försöker begära orienteringsåtkomst...");
            activateCompassButton.disabled = true; // Inaktivera medan vi frågar
            activateCompassButton.textContent = 'Begär åtkomst...';

            // --- iOS 13+ behörighetsförfrågan ---
            if ('DeviceOrientationEvent' in window && typeof DeviceOrientationEvent.requestPermission === 'function') {
                 DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        console.log("Resultat från requestPermission:", permissionState);
                        if (permissionState === 'granted') {
                            // Lägg TILL lyssnare FÖRST EFTER att tillstånd getts
                            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                            window.addEventListener('deviceorientation', handleOrientation, true); // Fallback
                            orientationListenerActive = true;
                            console.log("Orienteringslyssnare tillagd (iOS).");
                            // Knappen hanteras i handleOrientation när data tas emot
                        } else {
                            showError("Åtkomst till orienteringsdata nekades.");
                            activateCompassButton.disabled = false; // Återaktivera knappen vid nekat svar
                            activateCompassButton.textContent = 'Aktivera Kompass';
                        }
                    })
                    .catch(error => {
                         console.error("Fel vid begäran om orienteringsåtkomst:", error);
                         showError("Kunde inte begära åtkomst till orienteringsdata. (Fel: " + error.name + ")");
                         activateCompassButton.disabled = false; // Återaktivera knappen vid fel
                         activateCompassButton.textContent = 'Aktivera Kompass';
                     });
            }
            // --- För Android och äldre webbläsare (ingen explicit requestPermission) ---
            else if ('DeviceOrientationEvent' in window) {
                console.log("Lägger till standard 'deviceorientation' lyssnare (Android/äldre).");
                // Lägg till lyssnare direkt
                window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                window.addEventListener('deviceorientation', handleOrientation, true); // Fallback
                orientationListenerActive = true;
                 // Här kan vi inte veta säkert om det funkar förrän handleOrientation körs
                 // och sätter orientationPermissionGranted = true.
                 // Knappen uppdateras i handleOrientation. Om ingen data kommer,
                 // visas inget fel direkt, men knappen förblir aktiv.
                 // Sätt en liten fördröjning för att se om data kommer
                 setTimeout(() => {
                    if (!orientationPermissionGranted) {
                        console.warn("Ingen orienteringsdata mottagen efter 3 sek (Android/äldre).");
                        // Vi visar inget fel här, användaren kan försöka igen om de vill
                        activateCompassButton.disabled = false;
                        activateCompassButton.textContent = 'Aktivera Kompass (Försök igen?)';
                    }
                 }, 3000);

            }
            // --- Om API:et inte stöds alls ---
            else {
                showError("DeviceOrientationEvent stöds inte av din webbläsare/enhet.");
                activateCompassButton.textContent = 'Kompass stöds ej';
                // Behåll knappen inaktiverad
            }
        }

        // Hämta användarens position (samma som tidigare)
        function getLocation() {
             distanceElement.textContent = 'Hämtar position...';
             if (!errorElement.textContent.includes("orienteringsdata") && !errorElement.textContent.includes("kompassdata")) {
                 hideError();
             }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log(`Position hämtad: Lat ${position.coords.latitude}, Lon ${position.coords.longitude}`);
                        updateLocationUI(position.coords.latitude, position.coords.longitude);
                    },
                    handleLocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showError("Geolocation stöds inte av din webbläsare.");
                distanceElement.textContent = 'Geolocation stöds ej.';
            }
        }


        // --- Initialisering ---
        getLocation(); // Hämta position direkt

        // Lägg till event listener för knappen
        activateCompassButton.addEventListener('click', requestOrientationPermission);

        // Starta INTE orienteringslyssnaren automatiskt längre
        // startOrientationListener(); // Borttagen

    </script>

</body>
</html>
